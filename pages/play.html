<!doctype html>
<html>
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="/styles/custom.css">
        <title>Grant Hunt</title>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io('/play');
            var cardLastClicked;
            var otherPlayerCard;
            var playersInGame;
            var playersInRound;
            var playerId;
            var allRoles = {'Built Environment': 1, 'Arts':2, 'Law':3, 'Medicine':4, 'Science':5, 'Engineering':6, 'Business':7, 'UNSW':8}
            var winnersSoFar;
            var gameOver = false;

            socket.on('registration request', function(){
                var uid = sessionStorage.getItem('gameUniqueId');
                if(uid == null){
                    console.log("no session storage found, creating new ID");
                    var randomlyGeneratedUID = Math.random().toString(36).substring(3,16) + +new Date;

                    sessionStorage.setItem('gameUniqueId', randomlyGeneratedUID);
                } else {
                    console.log("session storage already found");
                }
                socket.emit('register', sessionStorage.getItem('gameUniqueId'));
            });

            socket.on('update', function(data){
                if(document.getElementById("status")){
                    document.getElementById("status").innerHTML = data + ' User(s) connected<br>';
                }
            });
            
            socket.on('player update', function(data){
                console.log(data);
                if(data <= 0) {
                    //show ready up button
                    //make it same width as share link
                    document.getElementById("waitingstatus").innerHTML = "You've connected to a game! Waiting for 0 more players";
                    shareWidth = document.getElementById("share-link").offsetWidth;
                    document.getElementById("start-round").style.display = "inline";
                    document.getElementById("start-round").style.width = shareWidth + 'px !important';
                    document.getElementById("share-link").style.display = "none";
                } else {
                    document.getElementById("waitingstatus").innerHTML = "You've connected to a game! Waiting for " + data + " more players";
                    document.getElementById("share-link").style.display = "inline";
                    document.getElementById("start-round").style.display = "none";
                }

            });
            
            socket.on('game full', function(){
                console.log('game full!')
                document.getElementById("waitingstatus").innerHTML = "The current game is full. You are currently spectating";
                document.getElementById("gameWait").setAttribute("class", "game waiting");
                // hide share link button
                document.getElementById("share-link").style.visibility = "hidden";
                //hide start round
                document.getElementById("start-round").style.visibility = "hidden";
                document.getElementById("gameInAction").style.visibility = "visible";
                document.querySelector("header > div[class='container text-center']").style.marginTop = "-10%";
                // remove status
                var parentOfStatus = document.getElementById("status").parentNode;
                parentOfStatus.removeChild(document.getElementById("status"));
                var parentOfShare = document.getElementById("share-link").parentNode;
                parentOfShare.removeChild(document.getElementById("share-link"));
                var parentOfStart = document.getElementById("start-round").parentNode;
                parentOfStart.removeChild(document.getElementById("start-round"));
                //remove gamewindow
                var parentOfWait = document.getElementById("gamewindow").parentNode;
                parentOfWait.removeChild(document.getElementById("gamewindow"));
            });

            socket.on('start game', function(data){
                //forcibly close modal
                $('#gameModal').modal('hide');
               
                //we need to handle when this is the first round or the next round separately
                if (document.getElementById("out")) {
                    if (!document.getElementById("playbutton")) {
                        //re-add in play button
                        a = document.createElement("a")
                        a.setAttribute("class","button");
                        a.setAttribute("id","playbutton");
                        a.setAttribute("onclick","playCard()");
                        a.style.visibility = "hidden";
                        a.innerHTML = "PlayCard";
                        // append button to somethin
                        document.getElementById("turnend").appendChild(a)
                    }
                    // out is the id given to h1 that tells players when they're out of the round
                    //this part is for when it's next round
                    // remove this part
                    var c = document.getElementById("cards");
                    c.removeChild(document.getElementById("out"))
                    if (document.getElementById("out")) {
                        //since players who aren't the winners have two h1s with id out
                        c.removeChild(document.getElementById("out"))
                    }
                    // hide next round button
                    var nextR = document.getElementById("nextRound");
                    nextR.parentNode.removeChild(nextR);
                    //reappend cards
                    appendNewCard(data,"card1")
                    document.getElementById("turnstatus").innerHTML = "It's not your turn yet.";
                } else {
                    if (!document.getElementById("playbutton")) {
                        //re-add in play button
                        a = document.createElement("a")
                        a.setAttribute("class","button");
                        a.setAttribute("id","playbutton");
                        a.setAttribute("onclick","playCard()");
                        a.innerHTML = "PlayCard";
                        document.getElementById("turnend").appendChild(a)
                    }
                    // hide share link button
                    document.getElementById("share-link").style.visibility = "hidden";
                    //hide start round
                    document.getElementById("start-round").style.visibility = "hidden";
                    
                    document.querySelector("header > div[class='container text-center']").style.marginTop = "-10%";
                    // remove status
                    var parentOfStatus = document.getElementById("status").parentNode;
                    parentOfStatus.removeChild(document.getElementById("status"));
                    //remove gameWait; copy button and waitingstatus
                    var parentOfWait = document.getElementById("gameWait").parentNode;
                    parentOfWait.removeChild(document.getElementById("gameWait"));
                     //remove gameInAction
                    var parentOfWait = document.getElementById("gameInAction").parentNode;
                    parentOfWait.removeChild(document.getElementById("gameInAction"));
                    // we need to show every player what their current hand is
                    appendNewCard(data,"card1")
                    document.getElementById("gamewindow").style.visibility = "visible";
                    document.getElementById("turnstatus").innerHTML = "It's not your turn yet.";
                    document.getElementById("playbutton").style.visibility = "hidden";
                }
            });
            
            socket.on('remaining players', function(remainingPlayersInGame, remainingPlayersInRound, pId){
                playersInGame = remainingPlayersInGame;
                playersInRound = remainingPlayersInRound;
                playerId = pId;
                console.log("remaining players");
                if(!document.getElementById("players")){
                    //add players count
                    var table = document.getElementsByClassName("player-table")[0];
                    var tbody = document.createElement("tbody");
                    tbody.setAttribute("id", "players");
                    table.appendChild(tbody);
                    for(var p in remainingPlayersInGame){
                        var row = document.createElement("tr");
                        row.setAttribute("name", "player-status");
                        var player = document.createElement("td");
                        var roundsWon = document.createElement("td");
                        roundsWon.innerHTML = "0";
                        player.innerHTML = p;
                        if(!remainingPlayersInRound.includes(remainingPlayersInGame[p])){
                            row.style.opacity = 0.25;
                        }
                        tbody.appendChild(row);
                        row.appendChild(player);
                        row.appendChild(roundsWon);
                    }
                } else {
                    //update players count for the round
                    console.log("updating")
                    var tr = document.getElementsByName("player-status");
                    for(var i=0; i < tr.length; i++){
                        var row = tr[i];
                        var td = row.getElementsByTagName("td");
                        var player = td[0];
                        var roundsWon = td[0];
                        for(var key in remainingPlayersInRound){
                            if(remainingPlayersInRound[key] == player.innerHTML){
                                row.style.opacity = 1;
                                break;
                            }
                            row.style.opacity = 0.25;
                        }
                    }
                }

            });
            
            socket.on('game update', function(currentPlayer, display_deck, history, immune){
                console.log("Game update");
                var historyContent = document.getElementById('history-content');
                removeCardData('history-content');
                console.log(history)
                for(var i=history.length; i>0; i--){
                    var message = document.createElement("p");
                    message.style.width = '100%';
                    message.innerHTML = history[history.length-i];
                    historyContent.appendChild(message);
                }
                //automatically scroll when new paragraph is added
                historyContent.scrollTop = historyContent.scrollHeight;

            });
            
            socket.on('your turn', function(currentPlayer, card1, card){
                document.getElementById("turnstatus").innerHTML = "It's your turn, Player " + currentPlayer + "!";
                playerId = currentPlayer;
                // only show the end turn button if it's the current player's turn

                document.getElementById("playbutton").style.visibility = "visible";

                // var card1 = document.getElementById("card1").childNodes;
                // console.log(card)
                appendNewCard(card, "card2");

                // only allow current player be able to click anything
                document.querySelector("div[id='card1'] > div").setAttribute("onclick", "saveInfo(this)");
            });

            socket.on('select player', function(playedCard, playerList, immunePlayers){
                submitModalButtonSwitch(playedCard);
                switch (playedCard){
                    case 1: 
                        builtEnvironment(playerList, immunePlayers);
                        break;
                    case 2:
                        arts(playerList, immunePlayers);
                        break;
                    case 3:
                        law(playerList, immunePlayers);
                        break;
                    case 5:
                        science(playerList, immunePlayers);
                        break;
                    case 6:
                        engineering(playerList, immunePlayers);
                        break;
                    default:
                        console.log("Emitting BLANK target player message");
                        socket.emit('target player', player, cardLastClicked.strength, null);
                        endTurn();
                        break;
                }
            });

            socket.on('invalid play', function(issue) {
                $('#gameModal').modal('show');
                submitModalButtonSwitch(null);
                document.getElementById('modal-title').innerHTML = "INVALID PLAY!";
                // if player has business + science or engineering, they MUST discard the latter.
                if(issue == "business"){
                    document.getElementById('information').innerHTML = "If you hold the Business card and either the Science or Engineering card, the Business card <strong>must<strong> be played immediately.";
                } else {
                    document.getElementById('information').innerHTML = "You cannot target a player who is immune (a player who has played Medicine).";
                }
                
                
                

            });

            socket.on('science draw', function(playedPlayer, newCard) {
                // draw new card for targeted player
                // set it for card 2
                console.log("science draw");
                
                // remove card1 and replace with newCard
                removeCardData("card1");
                appendNewCard(newCard, "card1");
                // notify player that someone has targeted them and their existing card will be discarded
                $('#gameModal').modal('show');
                submitModalButtonSwitch(null);
                document.getElementById('modal-title').innerHTML = "Player " + playedPlayer + " has played Medicine and targeted you!";
                document.getElementById('information').innerHTML = "As a result, your existing card has been discarded and your new card is: " + newCard.name;

            });

            socket.on('round finished', function(winners) {
                if(gameOver == false){
                    console.log("round FINISHED");
                    winnersSoFar = winners;
                    // remove cards
                    // show who has won the game
                    //
                    removeCardData("card1");
                    removeCardData("card2");

                    document.getElementById("playbutton").style.visibility = "hidden";
                    document.getElementById("turnstatus").innerHTML = "";
                    //display you're out message!
                    if(document.getElementById("out")){
                        var outmsg = document.getElementById("out");
                        outmsg.parentNode.removeChild(outmsg);
                    }
                
                    var row = document.getElementById("cards");
                    var message = document.createElement("h1");
                    if (winners.length == 1) {
                        // only 1 winner
                        if (winners[0] == playerId) {
                            message.innerHTML = "You are the winner of this round"
                        } else {
                            message.innerHTML = "Player " + winners[0] + " is the winner of this round"    
                        }
                        // we also need to increment the winner's rounds won
                        // this is under assumption that there is only 1 winner
                        var query = "tbody[id='players'] > tr:nth-child(" + String(parseInt(winners[0])+1) + ") > td:nth-child(2)"
                        var winnerInTable = document.querySelector(query);
                        winnerInTable.textContent = parseInt(winnerInTable.textContent) + 1
                        
                        
                    } else {
                        message.innerHTML = "Players ";
                        for (var i = 0; i < winners.length; i ++) {
                            if (i == winners.length-1) {
                                message.innerHTML = message.innerHTML + ' and ' + winners[i];
                            } else {
                                message.innerHTML = message.innerHTML + ' ' + winners[i] + ', ';
                            }
                            // we also need to increment the winner's rounds won
                            var winnerInTable = document.querySelector("tbody[id='players'] > tr:nth-child(" + winners[i]+1 + ") > td:nth-child(2)");
                            winnerInTable.textContent = parseInt(winnerInTable.textContent) + 1
                        }
                        message.innerHTML += " are the winners of this round!";

                    }

                    
                    message.style.marginLeft = "auto";
                    message.style.marginRight = "auto";
                    message.setAttribute("id", "out");
                    row.appendChild(message);



                    //add a button 'next round' that all players must click in order to move onto the next round
                    //first, remove play card button
                    var playCard = document.getElementById("playbutton");
                    playCard.parentNode.removeChild(playCard);
                    // playCard.style.visibility = "hidden";
                    var nextRoundButton = document.createElement("a")
                    nextRoundButton.innerHTML = "Next Round"
                    nextRoundButton.setAttribute("class", "button-full")
                    nextRoundButton.setAttribute("id","nextRound")
                    nextRoundButton.setAttribute("onclick","readyUp()")
                    document.getElementById("turnend").appendChild(nextRoundButton)
                    //let all players know who has pressed that button
                }
            });

            socket.on('all immune', function() {
                $('#gameModal').modal('show');
                //Change modal button to close
                submitModalButtonSwitch(null);
                //Display message
                document.getElementById('modal-title').innerHTML = "All other players are immune";
                document.getElementById('information').innerHTML = "All other players are immune, your card's effects do not take affect!";
            });

            function appendNewCard(card, cardToAddTo) {
                var card2 = document.getElementById(cardToAddTo);

                var cardData = document.createElement("div");
                cardData.setAttribute("class","card");
                cardData.setAttribute("onclick","saveInfo(this)");
                var card_body = document.createElement("div")
                card_body.setAttribute("class","card-body");
                

                var cardTitle = document.createElement("h5");
                cardTitle.style.paddingBottom = "5%";
                var cardImage = document.createElement("img");
                var cardText = document.createElement("p");

                cardTitle.style.color = "black";
                cardTitle.innerHTML = card.name;
                var image = "/images/"+card.strength+".png";
                cardImage.setAttribute("src", image);
                cardImage.style.width = "50%";
                cardText.style.color = "black";
                cardText.style.paddingTop = "5%";
                // cardText.appendChild(text);
                cardText.innerHTML = "Strength: " + card.strength + "<br>Effect: " + card.description;
                card_body.appendChild(cardTitle);
                card_body.appendChild(cardImage);
                card_body.appendChild(cardText);
                cardData.appendChild(card_body);

                card2.appendChild(cardData)
            }

            socket.on('built result', function(playedPlayer, targetPlayer, guessedCard, val){
                $('#gameModal').modal('show');
                //Change modal button to close
                submitModalButtonSwitch(null);
                //Display message
                console.log(guessedCard);
                var message = "";
                if(targetPlayer == playerId){
                    document.getElementById('modal-title').innerHTML = "Player " + playedPlayer + " played Built Environment against you";
                    message = "Player " + playedPlayer + " guessed that you have " + guessedCard.name;
                    if(val){
                        message += " and was correct. <br> <strong>YOU'VE BEEN KNOCKED OUT OF THE ROUND</strong>";
                    } else {
                        message += " and was wrong! <br> <strong> You stay in the round! </strong>";
                    }
                } else {
                    document.getElementById('modal-title').innerHTML = "You've played Built Environment";
                    message = "You guessed that Player " + targetPlayer + " has " + guessedCard.name;
                    if(val){
                        message += " and was correct. <br> <strong>PLAYER " + targetPlayer + " HAS BEEN KNOCKED OUT OF THE ROUND</strong>";
                    } else {
                        message += " and was wrong!<br> <strong>Player " + targetPlayer + " stays in the round! </strong>";
                    }
                }
                document.getElementById('information').innerHTML = message;
            });

            socket.on('arts result', function(targetPlayer, cardInfo) {
                $('#gameModal').modal('show');
                //Change modal button to close
                submitModalButtonSwitch(null);
                //Display message
                document.getElementById('modal-title').innerHTML = "You've played Arts";
                document.getElementById('information').innerHTML = "Player " +  targetPlayer + " has the card " + cardInfo.name;
            });

            socket.on('law loss', function(hands) {
                $('#gameModal').modal('show');
                //Change modal button to close
                submitModalButtonSwitch(null);
                //Display message
                if(hands['player'][0] == playerId){
                    var winnerName = hands['target'][0];
                    var winnerCard = hands['target'][1].name;
                    var loserName = hands['player'][0];
                    var loserCard = hands['player'][1].name;  
                    document.getElementById('modal-title').innerHTML = "You've played Law";
                } else {
                    var winnerName = hands['player'][0];
                    var winnerCard = hands['player'][1].name;
                    var loserName = hands['target'][0];
                    var loserCard = hands['target'][1].name; 
                    document.getElementById('modal-title').innerHTML = "Player " + hands['player'][0] + " played Law against you";
                }
                document.getElementById('information').innerHTML = "Player " +  winnerName + " has the card " + winnerCard + "<br>" +
                                                                    "Player " +  loserName + " has the card " + loserCard + "<br>" +
                                                                        "<strong>YOU'VE BEEN KNOCKED OUT OF THE ROUND!</strong>";
            });

            socket.on('law win', function(hands) {
                $('#gameModal').modal('show');
                //Change modal button to close
                submitModalButtonSwitch(null);
                //Display message
                if(hands['player'][0] == playerId){
                    var winnerName = hands['player'][0];
                    var winnerCard = hands['player'][1].name;
                    var loserName = hands['target'][0];
                    var loserCard = hands['target'][1].name; 
                    document.getElementById('modal-title').innerHTML = "You've played Law";
                } else {
                    var winnerName = hands['target'][0];
                    var winnerCard = hands['target'][1].name;
                    var loserName = hands['player'][0];
                    var loserCard = hands['player'][1].name;   
                    document.getElementById('modal-title').innerHTML = "Player " + hands['player'][0] + " played Law against you";
                }
                document.getElementById('information').innerHTML = "Player " +  winnerName + " has the card " + winnerCard + "<br>" +
                                                                    "Player " +  loserName + " has the card " + loserCard + "<br>" +
                                                                        "<strong>YOU'VE KNOCKED YOUR OPPONENT OUT OF THE ROUND!</strong>";
            });

            socket.on('law tie', function(hands, targetPlayer) {
                $('#gameModal').modal('show');
                //Change modal button to close
                submitModalButtonSwitch(null);
                //Display message
                if(hands['player'][0] == playerId){
                    var opponentName = hands['target'][0];
                    var opponentCard = hands['target'][1].name;
                    document.getElementById('modal-title').innerHTML = "You've played Law";
                } else {
                    var opponentName = hands['player'][0];
                    var opponentCard = hands['player'][1].name;
                    document.getElementById('modal-title').innerHTML = "Player " + opponentName + " played Law against you";
                }
                document.getElementById('information').innerHTML = "Player " +  opponentName + " has the card " + opponentCard + " and so do you!<br>" +
                                                                        "<strong>It's a tie, you both stay in the round!</strong>";
            });


            socket.on('eng swap',function(newCard, player, target) {
                //player can either be target player or player who has played the card
                //there is a separate emit for target player and player who has played the card
                //display "you and ___ have switched hands. your new hand is"
                $('#gameModal').modal('show');
                submitModalButtonSwitch(null);
                // console.log("my playerid: " + playerId);
                // console.log("target: " + target)
                if (playerId == player) {
                    // you are the person who has played engineering
                    document.getElementById('modal-title').innerHTML = "You have switched hands with player " + target;
                } else {
                    document.getElementById('modal-title').innerHTML = "Player " + player + " played Engineering against you";
                }
                document.getElementById('information').innerHTML = "Your new card is: " + newCard.name

                //remove card1
                removeCardData("card1")
                //append new card
                appendNewCard(newCard,"card1")
            });
            
            function removeCardData(cardToRemove) {
                var card = document.getElementById(cardToRemove);
                while (card.firstChild) {
                    card.removeChild(card.firstChild);
                }
            }
            
            function copyToClipboard() {
                var textArea = document.createElement("textarea")
            
                textArea.value = window.location.href;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('Copy');

                document.body.removeChild(textArea);
            }

            function playCard(){
                if (!cardLastClicked && !otherPlayerCard) {
                    // player has not selected anything
                    // let player know that they cannot proceed until they select a card
                    // show modal
                    $('#gameModal').modal.show()
                    document.getElementById('modal-title').innerHTML = "Wait a minute....";
                    document.getElementById('information').innerHTML = "You haven't selected any card to play! You can't proceed without selecting and playing a card!";
                    submitModalButtonSwitch(null);
                    return;
                }

                var playedCard = nameToValue(cardLastClicked); 
                var otherCard = nameToValue(otherPlayerCard);
                socket.emit('play card', playedCard, otherCard);
                console.log("playedCard = " + playedCard);
                console.log("otherCard = " + otherCard);
                cardLastClicked.strength = playedCard;
                otherPlayerCard.strength = otherCard;
                console.log("strength of last clicked = " + cardLastClicked.strength);
                console.log("emitted played card:"+playedCard+","+otherCard);
                if(playedCard == 8 || playedCard == 7 || playedCard == 4){
                    endTurn();
                }         
            }

            function endTurn() {
                document.getElementById("playbutton").style.visibility = "hidden";
                document.getElementById("turnstatus").innerHTML = "It's not your turn yet.";

                // we need to delete the card that has been chosen
                // we use cardLastClicked.cardNum to determine which children to remove
                // if card1 is removed, we should move card2 data over to card1 and then delete card2
                var card2Clone;
                if (cardLastClicked.cardNum == "card1") {
                    card2Clone = (document.getElementById("card2").childNodes)[0].cloneNode(true);
                    // remove card1
                    removeCardData("card1")
                    
                    card1.appendChild(card2Clone);
                }
                removeCardData("card2")
                cardLastClicked = undefined;
                  
            }

            //returns card value
            function nameToValue(card){
                switch (card.name) {
                    case "Built Environment":
                        return 1;
                    case "Arts":
                        return 2;
                    case "Law":
                        return 3;
                    case "Medicine":
                        return 4;
                    case "Science":
                        return 5;
                    case "Engineering":
                        return 6;
                    case "Business":
                        return 7;
                    default:
                        return 8;
                }
            }

            //if the current player is not in the game
            //we need to remove their cards and tell them that they're out!
            // double check that curr player is actually not in the round anymore (safety)
            
            socket.on('eliminated', function(players){
            	console.log("I got eliminated!");

                var stillInRound = false;
                for(var p in players){
                    if(players[p] == playerId){
                        stillInRound = true;
                        console.log("player " + playerId + " is still in the game")
                        break;
                    }
                }
                if(!stillInRound && !document.getElementById('out')){
                    console.log("player " + playerId + " is NOT in the game")
                    //make sure they have no cards in their hand
                    removeCardData("card1");
                    removeCardData("card2");
                    document.getElementById("turnstatus").innerHTML = "";
                    //display you're out message!
                    var row = document.getElementById("cards");
                    var message = document.createElement("h1");
                    message.innerHTML = "YOU'RE OUT OF THE ROUND!";
                    message.style.marginLeft = "auto";
                    message.style.marginRight = "auto";
                    message.setAttribute("id", "out");
                    row.appendChild(message);
                }
                document.getElementById("playbutton").style.visibility = "hidden";
            });

            function submitModalButtonSwitch(playedCard){
                var btn =  document.getElementById('modal-submit');
                btn.style.display = "block";
                console.log("submit :" + typeof(playedCard))
                switch(playedCard){
                    case 1: case 2: case 3: case 4: case 5: case 6: case 7:
                        //display the submit button
                       btn.innerHTML = "Submit";
                       btn.setAttribute("onclick", "submitModal();");
                       break;
                    default:
                        //display a button to close the modal
                        btn.innerHTML = "Close";
                        btn.removeAttribute("onclick");

                }
            }

            function builtEnvironment(playerList, immunePlayers){
                $('#gameModal').modal('show');
                document.getElementById('modal-title').innerHTML = "You've played Built Environment";
                document.getElementById('information').innerHTML = "Guess the name of a card in your opponent's hand to knock them out of the round";
                appendPlayersList(playerList, immunePlayers);
                //Append roles
                var roleLabel = document.createElement("label");
                document.getElementById('modal-body').appendChild(roleLabel);
                roleLabel.setAttribute("for", "roleSelect");
                roleLabel.innerHTML = "Select a role:";
                var roles = document.createElement("select");
                document.getElementById('modal-body').appendChild(roles);
                roles.setAttribute("id", "roleSelect");
                roles.setAttribute("name", "roleSelect");
                roles.setAttribute("class", "form-control");
               
                for(var role in allRoles){
                    if(role != "Built Environment"){
                        //create an <option> to add the <select>
                        var child = document.createElement("option");
                        //assign values to the <option>
                        child.textContent = role
                        child.value = allRoles[role];
                        //attach the mew <option> to the <selection>
                        roles.appendChild(child);
                    }
                }

            }

            function arts(playerList, immunePlayers) {
                // to take care of arts
                // playing arts lets us take a look at other people's hands
                $('#gameModal').modal('show');
                document.getElementById('modal-title').innerHTML = "You've played Arts";
                document.getElementById('information').innerHTML = "Pick a player to look at their hand!";

                appendPlayersList(playerList, immunePlayers);
            }
          
            function law(playerList, immunePlayers){

                $('#gameModal').modal('show');
                document.getElementById('modal-title').innerHTML = "You've played Law";
                document.getElementById('information').innerHTML = "Select an opponent and the player with the lower strength card in their hand is knocked out of the round.";
                appendPlayersList(playerList, immunePlayers);
            }
          
            function science(playerList, immunePlayers) {
                $('#gameModal').modal('show');
                document.getElementById('modal-title').innerHTML = "You've played Science";
                document.getElementById('information').innerHTML = "Select an opponent and discard their hand and draw a new card.";
                appendPlayersList(playerList, immunePlayers);
            }

            function engineering(playerList, immunePlayers) {
                $('#gameModal').modal('show');
                document.getElementById('modal-title').innerHTML = "You've played Engineering";
                document.getElementById('information').innerHTML = "Select an opponent and trade hands with them.";
                appendPlayersList(playerList, immunePlayers);

            }

            function appendPlayersList(playerList, immunePlayers){
                //Append players
                var playersLabel = document.createElement("label");
                document.getElementById('modal-body').appendChild(playersLabel);
                playersLabel.setAttribute("for", "playerSelect");
                playersLabel.innerHTML = "Select a player:";
                var players = document.createElement("select");
                document.getElementById('modal-body').appendChild(players);
                players.setAttribute("id", "playerSelect");
                players.setAttribute("name", "playerSelect");
                players.setAttribute("class", "form-control");
                for (var p in playersInRound){
                    //create an <option> to add the <select>
                    var child = document.createElement("option");
                    //assign values to the <option>
                    if(playerId == playersInRound[p]){
                        child.textContent = playersInRound[p] + " (You)";
                    } else {
                        child.textContent = playersInRound[p];
                    }
                    
                    // check if the player is immune
                    if (immunePlayers.includes(playersInRound[p])) {
                        child.textContent = child.textContent + " (Medicine)";
                        child.value = child.value + " (Medicine)";
                        // also need to disable this option
                        child.disabled = true;
                    }
                    child.value = playersInRound[p];
                              
                    //attach the mew <option> to the <selection>
                    players.appendChild(child);
                    
                }
                // we need to disable 
            }

            function submitModal(){
                console.log("in submitModal, cardLastClicked strength = " + cardLastClicked.strength);
                switch (cardLastClicked.strength) {
                    case 1: 
                        //Built environment: get the values from both selects and send to backend
                        var r = document.getElementById("roleSelect");
                        var role = r.options[r.selectedIndex].value;
                        var p = document.getElementById("playerSelect");
                        var player = p.options[p.selectedIndex].value;
                        socket.emit('target player', player, cardLastClicked.strength, role);
                        // console.log(player, cardLastClicked.strength, role)
                        break;
                    case 2:
                        var p = document.getElementById("playerSelect");
                        var player = p.options[p.selectedIndex].value;
                        socket.emit('target player', player, cardLastClicked.strength);
                        break;
                    case 3:
                         //Law: get the values from player select and send to backend
                        var p = document.getElementById("playerSelect");
                        var player = p.options[p.selectedIndex].value;
                        console.log("Emitting target player message");
                        socket.emit('target player', player, cardLastClicked.strength, null);
                        break;
                    case 5:
                        var p = document.getElementById("playerSelect");
                        var player = p.options[p.selectedIndex].value;
                        socket.emit('target player', player, cardLastClicked.strength, null);
                        break;
                    case 6:
                        var p = document.getElementById("playerSelect");
                        var player = p.options[p.selectedIndex].value;
                        socket.emit('target player', player, cardLastClicked.strength, null);
                        break;
                    default:
                        socket.emit('target player', player, cardLastClicked.strength, null);
                }
                // we need to remove the contents of the modal because at the moment, if 
                // the same player plays built environ next turn, there will be two modal bodies
                var modal_body = document.getElementById('modal-body');
                var modal_body_children = document.getElementById('modal-body').childNodes;
                while (modal_body.lastChild.id !== 'information') {
                    modal_body.removeChild(modal_body.lastChild);
                }

                endTurn();

            }


            function saveInfo(card) {
                cardChildren = card.childNodes;
                cardGrandChildren = cardChildren[0].childNodes;

                parent = card.parentNode;
                cardLastClicked = {
                    "name":cardGrandChildren[0].innerHTML,
                    "cardNum": parent.id,
                    "strength": -1
                };

                if (parent.id == "card1") {
                    // other card is card2
                    card2 = document.getElementById("card2");
                    card2Child = card2.childNodes;
                    grandchild = card2Child[0].childNodes;
                    content = grandchild[0].childNodes;

                    otherPlayerCard = {
                        "name": content[0].innerHTML,
                        "cardNum": "card2"
                    }

                } else if (parent.id == "card2") {
                    card1 = document.getElementById("card1");
                    card1Child = card1.childNodes;
                    grandchild = card1Child[0].childNodes;
                    content = grandchild[0].childNodes;

                    otherPlayerCard = {
                        "name": content[0].innerHTML,
                        "cardNum": "card1",
                        "strength": -1
                    };
                }
                // first, we need to check if card1 or card2 was clicked

                if (parent.id == "card1") {
                    // add active class
                    card.classList.add("active");
                    // remove active calss of other card if it exists
                    card2 = document.getElementById("card2");
                    if (card2.childNodes[0].classList.contains("active")) {
                        card2.childNodes[0].classList.remove("active");
                    }
                } else if (parent.id=="card2") {
                    card.classList.add("active");
                    // remove active calss of other card if it exists
                    card1 = document.getElementById("card1");
                    if (card1.childNodes[0].classList.contains("active")) {
                        card1.childNodes[0].classList.remove("active");
                    }
                }

            }

            function readyUp() {
                //add confirmation to the player that they have selected to ready up
                //maybe how many players are left to ready up
                //use modal pop up
                console.log("I am ready")
                $('#gameModal').modal('show');
                document.getElementById('modal-title').innerHTML = "You've chosen to ready up";
                document.getElementById('information').innerHTML = "We are currently waiting for other players to ready up. Please be patient.";
                // document.getElementById('information').innerHTML = "Waiting on " + "" + " players to ready up";
                // completely remove the modal button
                document.getElementById('modal-submit').style.display = "none";
                // submitModalButtonSwitch(null);
                socket.emit("ready");
            }

            socket.on('game finished',function(winners, status) {
                console.log("Game over!");
                
                //make sure they have no cards in their hand
                removeCardData("card1");
                removeCardData("card2");

                if(document.getElementById("out")){
                    var outmsg = document.getElementById("out");
                    outmsg.parentNode.removeChild(outmsg);
                }

                if(document.getElementById("playbutton")){
                    var playbtn = document.getElementById("out");
                    playbtn.parentNode.removeChild(playbtn);
                }
            
                document.getElementById("turnstatus").innerHTML = "";
                //display you're out message!
                if(status == "player"){
                    var row = document.getElementById("cards");
                } else {
                    var row = document.getElementById("history");
                }
                
                var message = document.createElement("h1");
                var text = "THE GAME HAS ENDED!<br>";
                if(winners.length > 1){
                    text += " The winners are:";
                    for(var j=0; j<winners.length; j++){
                        text += " Player ";
                        text += winners[j];
                        if(winners[j] != winners[winners.length-1]){
                            text +=  ", ";
                        }
                        // we also need to increment the winner's rounds won
                        var winnerInTable = document.querySelector("tbody[id='players'] > tr:nth-child(" + winners[i]+1 + ") > td:nth-child(2)");
                        winnerInTable.textContent = parseInt(winnerInTable.textContent) + 1
                    }
                } else {
                    text += " The winner is Player " + winners;
                    //increment rounds won
                    var query = "tbody[id='players'] > tr:nth-child(" + String(parseInt(winners[0])+1) + ") > td:nth-child(2)"
                    var winnerInTable = document.querySelector(query);
                    winnerInTable.textContent = parseInt(winnerInTable.textContent) + 1
                }
               
                message.innerHTML = text;
                message.style.marginLeft = "auto";
                message.style.marginRight = "auto";
                message.setAttribute("id", "out");
                row.appendChild(message);
                
                document.getElementById("playbutton").style.visibility = "hidden";
                //create a button to go back to the play page
                var playAgainButton = document.createElement("a")
                playAgainButton.innerHTML = "Play again"
                playAgainButton.setAttribute("class", "button")
                playAgainButton.setAttribute("id","playPage")
                playAgainButton.setAttribute("onclick","window.location.reload()")
                playAgainButton.style.marginLeft = "auto";
                playAgainButton.style.marginRight = "auto";
                document.getElementById("turnend").appendChild(playAgainButton)
                gameOver = true;
            });
        </script>
    </head>
    <body>
    <nav class="navbar navbar-light fixed-top">
        <a class="navbar-left" href="/">
            <img src="/images/logo.png" width="200" alt="">
            <ul>
                <li><a href="rules">Rules</a></li>
                <li><a href="/" style="color: #ff9300" onclick="confirmLeave()">Leave Game</a></li>
            </ul>
        </a>
    </nav>
    
    
    <header class="home-banner d-flex">
        <div class="container text-center">   
            <div id='gameWait' class="waiting">
                <p id="waitingstatus" class="loading status"></p>
                <a class="button" id="share-link" onclick="copyToClipboard()">Click to copy shareable link!</a>
                <a class="button-full" id="start-round" onclick="readyUp()">Click to ready up!</a>
            </div>

            <div id='gameInAction' style="visibility: hidden; height:100%;">
                <div class="game gameInAction-history" id="history" >
                    <h6>HISTORY</h6>
                    <hr>
                    <div id="history-content" class="history-content">
                    </div>
                </div>
                <div class="game-sidebar" id="game-sidebar">
                    <div id="player">
                        <h6>Players</h6>
                        <hr>
                        <table class="player-table">
                            <thead>
                                <tr>
                                    <th scope="col">Player</th>
                                    <th scope="col">Rounds Won</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="gamewindow" action="" style="visibility: hidden;" >
                <div class="game-sidebar" id="game-sidebar">
                    <div class="history" id="history" >
                        <h6>HISTORY</h6>
                        <hr>
                        <div id="history-content" class="history-content">
                        </div>
                    </div>
                    <div id="player">
                        <h6>Players</h6>
                        <hr>
                        <table class="player-table">
                            <thead>
                                <tr>
                                    <th scope="col">Player</th>
                                    <th scope="col">Rounds Won</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="game text-center">
                    <p id="status" class="game-status"></p>
                    <p id="turnstatus" class="game-status"></p>
                    <div class="row" id="cards">
                        <div class="col-6" id="card1"></div>
                        <div class="col-6" id="card2"></div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12" id="turnend">
                            <a class="button" id="playbutton" onclick="playCard()">Play Card</a>
                        </div>
                        
                    </div>
                </div>    
            </div>

            
            <!-- option 1 -->
            
            <!-- option 2 -->
            <!-- <div class="row">
                <div class="col-lg-12 mx-auto">
                    <input class="text" id="copy" value="test" style="visibility: hidden" readonly/>
                    <button class='copy-btn' id="share-link" style="visibility: hidden" onclick="copyToClipboard()">Copy</button>
                </div>
            </div> -->
        </div>
    </header>
    <!-- Modal -->
    <div class="modal" id="gameModal" data-backdrop='static'>
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title" id="modal-title"></h4>
                    <!-- <button type="button" class="close" data-dismiss="modal">&times;</button> -->
                </div>
                
                <!-- Modal body -->
                <div class="modal-body" id="modal-body">
                    <p id="information"></p>
                </div>
                
                <!-- Modal footer -->
                <div class="modal-footer">
                    <a class="button-full" data-dismiss="modal" id="modal-submit" onClick="submitModal()">Submit</a>
                </div>
                
            </div>
        </div>
    </div>
    </body>
</html>